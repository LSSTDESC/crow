name: crow-ci

on:
  push:
    branches:
      - main
  pull_request:

env:
  CONDA_ENV: crow-env

jobs:
  quick-validation:
    name: Quick validation (Lint + Tests)
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repository
      - uses: actions/checkout@v4

      # 2. Set up Miniconda
      - name: Set up Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          environment-file: environment.yml
          activate-environment: ${{ env.CONDA_ENV }}
          python-version: 3.12
          auto-activate-base: false
          use-mamba: true

      # 3. Verify environment
      - name: Verify conda environment
        run: |
          conda info
          conda list

      # 4. Linting with black
      - name: Check code formatting with black
        run: |
          conda run -n ${{ env.CONDA_ENV }} black --check --diff crow tests

      # 5. Import sorting with isort
      - name: Check import order with isort
        run: |
          conda run -n ${{ env.CONDA_ENV }} isort --check --diff crow tests

      # 6. Run tests with pytest
      - name: Run tests with pytest
        run: |
          conda run -n ${{ env.CONDA_ENV }} pytest -v --maxfail=1 --disable-warnings

      # 7. Upload coverage to Coveralls
      - name: Coveralls
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COVERALLS_REPO_TOKEN: ${{ secrets.COVERALLS_REPO_TOKEN }}
        run: |
          conda run -n ${{ env.CONDA_ENV }} pip install coverage coveralls
          conda run -n ${{ env.CONDA_ENV }} coverage run -m pytest
          conda run -n ${{ env.CONDA_ENV }} coverage report -m
          conda run -n ${{ env.CONDA_ENV }} coveralls --service=github
